<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>ALTTP Graphics</title>
	<link href="https://fonts.googleapis.com/css?family=Teko:600&amp;subset=latin-ext" rel="stylesheet">
	<link rel="stylesheet" href="style/layout.css">

	<link rel="import" href="elements/molecules/alttp-tracker/alttp-tracker.html">
</head>
<body>
	<div id="container">
		<img id="background" src="assets/backgrounds/bg2-blank.png">
		<layout-app></layout-app>
	</div>

	<dom-module id="layout-app">
		<template>
			<link href="style/restream.css" rel="stylesheet" type="text/css" >
			
			<template is="dom-repeat" items="[[runners]]" as="runner">
				<div id="runner[[index]]">
					<div class="runnerName">
						[[runner.name]]
					</div>
					<div class="runnerTimer">
						[[calcRunnerStatus(results, index)]]
					</div>
					<alttp-tracker 
						item-trackers="[[itemTrackers]]" 
						index="[[index]]"
						password="[[password]]"></alttp-tracker>
					<div class="runnerStream">
					</div>
					<div class="runnerExtra">
						<img src="[[calcStatusGraph(results, index)]]" />
					</div>
				</div>
			</template>

			<div id="category">
				[[category]]
			</div>
			<div id="commentators">
				<img src="assets/images/commentator.png" /> [[commentators]]
			</div>
			<div id="matchInfo">
				[[round]] <br />
				[[standings]]
			</div>
		</template>



		<script>
			const currentRun = nodecg.Replicant('currentRun');
			const currentRunExtra = nodecg.Replicant('currentRunExtra');
			const stopwatch = nodecg.Replicant('stopwatch');

			Polymer({
				is: 'layout-app',

				properties: {
					numRunners: {
						type: Number,
						reflectToAttribute: true,
						value: 1
					},
					runners: Array,
					results: Array,
					time: String,
					commentators: String,
					category: String,
					round: String,
					standings: String,
					baseUrl: String,
					itemTrackers: Array
				},

				ready() {

					stopwatch.on('change', this.stopwatchChanged.bind(this));
					currentRun.on('change', newVal => {
						if (!newVal) {
							return;
						}
						this.commentators = newVal.commentators.map(comm => comm.name).join(', ');
						this.runners = newVal.runners;
						this.category = newVal.category;
						if (newVal.runners.length !== 3 && newVal.runners.length <= 4) {
							this.numRunners = newVal.runners.length;
						}
					});

					currentRunExtra.on('change', newVal => {
						if(!newVal)
							return;
						this.round = newVal.round;
						this.standings = newVal.standings;
						this.password = newVal.password;
						this.set('itemTrackers', newVal.itemTrackers.slice(0));
					});

				},

				stopwatchChanged(newVal) {
					this.time = newVal.time.formatted;
					this.results = newVal.results.slice(0);
				},

				calcRunnerStatus(results, index){
					if (!results) {
						return;
					}
					if(results[index] && results[index].forfeit)
						return '';

					if (results[index] && results[index].time && results[index].time.formatted !== "00:00") {
						return results[index].time.formatted;
					}

					if(this.time && this.time !== "00:00")
						return this.time;
					
				},
				calcStatusGraph(results, index) {
					if (!results) {
						return "assets/images/standby.png";
					}

					if(results[index] && results[index].forfeit)
						return "assets/images/forfeit.png"; 
					
					if(results[index] && results[index].place === 1)
						return "assets/images/winner.png"; 

					return "assets/images/standby.png";


				}
			});
		</script>
	</dom-module>
</body>
</html>
